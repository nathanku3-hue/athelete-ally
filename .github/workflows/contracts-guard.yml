name: Contracts Version Guard

on:
  pull_request:
    paths:
      - 'packages/contracts/**'
      - 'services/**/package.json'
      - 'apps/**/package.json'
  workflow_dispatch:

jobs:
  sanity:
    uses: ./.github/workflows/_sanity-reuse.yml

  contracts-guard:
    runs-on: ubuntu-latest
    needs: [sanity]
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.18.0'
          cache: 'npm'
          cache-dependency-path: ${{ needs.sanity.outputs.cache-dependency-path || 'package-lock.json' }}

      - name: Install dependencies


        run: npm ci --no-audit --no-fund
      - name: Check contracts version bump
        run: |
          echo "üîç Checking if contracts package version was bumped..."
          
          # Get the current contracts version
          CURRENT_VERSION=$(node -p "require('./packages/contracts/package.json').version")
          echo "Current contracts version: $CURRENT_VERSION"
          
          # Check if contracts files were modified
          CONTRACTS_CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -c -E '^packages/contracts/' || echo 0)
          
          if [ "$CONTRACTS_CHANGED" -gt 0 ]; then
            echo "üì¶ Contracts package was modified"
            
            # Check if version was bumped
            VERSION_CHANGED=$(git diff HEAD~1 HEAD -- packages/contracts/package.json | grep -c -E '^\+.*"version"' || echo 0)
            
            if [ "$VERSION_CHANGED" -eq 0 ]; then
              echo "‚ö†Ô∏è  Warning: Contracts were modified but version was not bumped"
              echo "Consider bumping the version in packages/contracts/package.json"
              echo "This will become a blocking check in future releases"
            else
              echo "‚úÖ Contracts version was bumped appropriately"
            fi
          else
            echo "‚ÑπÔ∏è  No contracts changes detected"
          fi

      - name: Check dependent package updates
        run: |
          echo "üîç Checking if dependent packages need updates..."
          
          # Check if any service/app package.json references contracts
          DEPENDENTS=$(find . -name "package.json" -not -path "./node_modules/*" -not -path "./packages/contracts/*" -exec grep -l "@athlete-ally/contracts" {} \;)
          
          if [ -n "$DEPENDENTS" ]; then
            echo "üìã Packages depending on contracts:"
            echo "$DEPENDENTS"
            echo ""
            echo "üí° Consider updating these packages to use the new contracts version"
            echo "This will become a blocking check in future releases"
          else
            echo "‚úÖ No direct contract dependencies found"
          fi

      - name: Non-blocking status
        run: |
          echo "‚ÑπÔ∏è  This is a non-blocking check for now"
          echo "It will be promoted to blocking after monitoring a few successful runs"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true