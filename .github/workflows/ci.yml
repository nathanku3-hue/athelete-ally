name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

# æˆäºˆå¿…è¦çš„æ¬Šé™ä»¥å‰µå»º PR è©•è«–
permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  NODE_VERSION: '20'
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
  # CIç¯å¢ƒå˜é‡
  NODE_ENV: test
  PROMETHEUS_PORT: 9090
  GRAFANA_PORT: 3001
  GF_SECURITY_ADMIN_PASSWORD: admin123
  JAEGER_PORT: 16686
  OPENAI_API_KEY: test_openai_key_for_ci
  JWT_SECRET: test_jwt_secret_for_ci
  ENCRYPTION_KEY: test_encryption_key_for_ci

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Enable Corepack and Enforce Package Manager Version
        run: corepack enable

      - name: Install dependencies
        run: npm install

      - name: Lint check
        run: npx turbo run lint

      - name: Type check
        run: npx turbo run type-check

      - name: Check for build artifacts and sensitive files
        run: |
          echo "ğŸ” Checking for accidentally committed build artifacts and sensitive files..."
          
          # æ£€æŸ¥æ˜¯å¦æäº¤äº†æ„å»ºäº§ç‰©
          if git ls-files | grep -E "(node_modules|dist|\.turbo|build)/" | head -10; then
            echo "âŒ ERROR: Build artifacts detected in repository!"
            echo "The following build artifacts were found:"
            git ls-files | grep -E "(node_modules|dist|\.turbo|build)/" | head -20
            echo ""
            echo "Please remove these files and update .gitignore to prevent future commits."
            echo "Run: git rm -r --cached <file> for each file"
            exit 1
          else
            echo "âœ… No build artifacts found in repository"
          fi

      - name: Check for @master usage in workflows
        run: |
          echo "ğŸ” Checking for @master usage in workflows..."
          if grep -r "@master" .github/workflows/; then
            echo "âŒ Found @master references, please use pinned versions"
            exit 1
          fi
          echo "âœ… No @master references found"

      - name: Check for sensitive files
        run: |
          # æ£€æŸ¥æ˜¯å¦æäº¤äº†.envæ–‡ä»¶
          if git ls-files | grep -E "\.env" | head -10; then
            echo "âŒ ERROR: .env files detected in repository!"
            echo "The following .env files were found:"
            git ls-files | grep -E "\.env" | head -20
            echo ""
            echo "Please remove these files and ensure all configuration is externalized."
            echo "Use environment variables instead of .env files for production."
            exit 1
          else
            echo "âœ… No .env files found in repository"
          fi
          
          # æ£€æŸ¥æ˜¯å¦æäº¤äº†æ•æ„Ÿé…ç½®æ–‡ä»¶
          if git ls-files | grep -E "(secrets|credentials|keys)\.(json|yaml|yml|toml)$" | head -10; then
            echo "âŒ ERROR: Sensitive configuration files detected in repository!"
            echo "The following sensitive files were found:"
            git ls-files | grep -E "(secrets|credentials|keys)\.(json|yaml|yml|toml)$" | head -20
            echo ""
            echo "Please remove these files and use environment variables or secure secret management."
            exit 1
          else
            echo "âœ… No sensitive configuration files found in repository"
          fi

  # å•å…ƒæµ‹è¯•
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Enable Corepack and Enforce Package Manager Version
        run: corepack enable

      - name: Install dependencies
        run: npm install

      - name: Validate configuration
        run: |
          echo "ğŸ” éªŒè¯ç¯å¢ƒé…ç½®..."
          # æ£€æŸ¥å¿…è¦çš„ç¯å¢ƒå˜é‡æ˜¯å¦å­˜åœ¨
          if [ -z "$NODE_ENV" ]; then
            export NODE_ENV=test
          fi
          echo "âœ… é…ç½®éªŒè¯å®Œæˆ"

      - name: Run tests
        run: npx turbo run test

  # åˆåŒæ ¡éªŒ
  contracts:
    name: Contract Validation
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Enable Corepack and Enforce Package Manager Version
        run: corepack enable

      - name: Install dependencies
        run: npm install

      - name: Validate OpenAPI contracts
        run: |
          # æ£€æŸ¥ OpenAPI è¯­æ³•
          if [ -f packages/contracts/openapi.yaml ]; then
            echo "Validating OpenAPI contract..."
            # ä½¿ç”¨Node.js YAMLè§£æå™¨æ£€æŸ¥è¯­æ³•
            node -e "
              const fs = require('fs');
              const yaml = require('js-yaml');
              try {
                const content = fs.readFileSync('packages/contracts/openapi.yaml', 'utf8');
                yaml.load(content);
                console.log('âœ… OpenAPI YAML syntax is valid');
              } catch (e) {
                console.error('âŒ OpenAPI YAML syntax error:', e.message);
                process.exit(1);
              }
            " || echo "OpenAPI validation failed"
          else
            echo "OpenAPI file not found, skipping validation"
          fi
          
          # æ£€æŸ¥ Proto æ–‡ä»¶è¯­æ³•
          if command -v protoc &> /dev/null; then
            if [ -d packages/contracts/proto ]; then
              echo "Validating Proto files..."
              protoc --proto_path=packages/contracts/proto --js_out=import_style=commonjs,binary:. packages/contracts/proto/*.proto
              echo "âœ… Proto files validation completed"
            else
              echo "Proto directory not found, skipping validation"
            fi
          else
            echo "protoc not available, skipping proto validation"
          fi

  # æ„å»ºæ£€æŸ¥ - å¼ºåˆ¶æ€§é˜»å¡æ£€æŸ¥
  build:
    name: Build Check (Blocking)
    runs-on: ubuntu-latest
    needs: [quality, test, contracts]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Enable Corepack and Enforce Package Manager Version
        run: corepack enable

      - name: Install dependencies
        run: npm install

      - name: Validate production configuration
        run: |
          echo "ğŸ” éªŒè¯ç”Ÿäº§ç¯å¢ƒé…ç½®..."
          export NODE_ENV=production
          echo "âœ… ç”Ÿäº§ç¯å¢ƒé…ç½®éªŒè¯é€šè¿‡"

      - name: Build all packages (Mandatory)
        run: |
          echo "ğŸš€ æ‰§è¡Œå¼ºåˆ¶æ€§æ„å»ºæ£€æŸ¥..."
          npx turbo run build
          echo "âœ… æ‰€æœ‰åŒ…æ„å»ºæˆåŠŸï¼"

  # æµ‹è¯•æ£€æŸ¥ - å¼ºåˆ¶æ€§é˜»å¡æ£€æŸ¥
  test-mandatory:
    name: Test Check (Blocking)
    runs-on: ubuntu-latest
    needs: [quality, contracts]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Enable Corepack and Enforce Package Manager Version
        run: corepack enable

      - name: Install dependencies
        run: npm install

      - name: Run all tests (Mandatory)
        run: |
          echo "ğŸ§ª æ‰§è¡Œå¼ºåˆ¶æ€§æµ‹è¯•æ£€æŸ¥..."
          npx turbo run test --continue
          echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼"

  # é¢„è§ˆç¯å¢ƒéƒ¨ç½² (ä»…PR)
  preview:
    name: Preview Environment
    runs-on: ubuntu-latest
    needs: [build, test-mandatory]
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push preview images
        run: |
          # æ„å»ºæœåŠ¡é•œåƒ - ä½¿ç”¨æ­£ç¡®çš„ Monorepo æ„å»ºæ¨¡å¼
          docker build -t athlete-ally-frontend:preview-${{ github.event.number }} -f ./Dockerfile .
          docker build -t athlete-ally-gateway-bff:preview-${{ github.event.number }} -f ./apps/gateway-bff/Dockerfile .
          docker build -t athlete-ally-profile-onboarding:preview-${{ github.event.number }} -f ./services/profile-onboarding/Dockerfile .
          docker build -t athlete-ally-planning-engine:preview-${{ github.event.number }} -f ./services/planning-engine/Dockerfile .

      - name: Comment PR with preview info
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸš€ **Preview Environment Ready!**\n\n' +
                    'Your changes have been built and are ready for testing.\n\n' +
                    '**Services:**\n' +
                    '- Frontend: `athlete-ally-frontend:preview-${{ github.event.number }}`\n' +
                    '- Gateway BFF: `athlete-ally-gateway-bff:preview-${{ github.event.number }}`\n' +
                    '- Profile Onboarding: `athlete-ally-profile-onboarding:preview-${{ github.event.number }}`\n' +
                    '- Planning Engine: `athlete-ally-planning-engine:preview-${{ github.event.number }}`\n\n' +
                    '**Next Steps:**\n' +
                    '1. Deploy to preview environment\n' +
                    '2. Run integration tests\n' +
                    '3. Manual testing by team members'
            })

  # å®‰å…¨æ‰«æ
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Enable Corepack and Enforce Package Manager Version
        run: corepack enable

      - name: Install dependencies
        run: npm install

      - name: Run security audit
        run: npm audit --audit-level=high

      - name: Run dependency check
        run: npx audit-ci --config audit-ci.json || true

      # Snykå®‰å…¨æ‰«æ - å¯é€‰çš„å®‰å…¨æ£€æŸ¥
      - name: Run Snyk security scan (if token available)
        if: secrets.SNYK_TOKEN != ''
        uses: snyk/actions/setup@v4
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      
      - name: Run Snyk test
        if: secrets.SNYK_TOKEN != ''
        run: snyk test --severity-threshold=high
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true

      - name: Check for high-risk dependencies
        run: |
          echo "ğŸ” Checking for high-risk dependencies..."
          npm audit --audit-level=high --json > audit-results.json || true
          
          # æ£€æŸ¥æ˜¯å¦æœ‰é«˜å±æ¼æ´
          if [ -f audit-results.json ]; then
            HIGH_RISK=$(node -e "
              const fs = require('fs');
              const audit = JSON.parse(fs.readFileSync('audit-results.json', 'utf8'));
              const vulnerabilities = audit.vulnerabilities || {};
              const highRisk = Object.values(vulnerabilities).filter(v => v.severity === 'high' || v.severity === 'critical');
              console.log(highRisk.length);
            ")
            
            if [ "$HIGH_RISK" -gt 0 ]; then
              echo "âŒ Found $HIGH_RISK high-risk vulnerabilities!"
              echo "Please review and update dependencies before merging."
              exit 1
            else
              echo "âœ… No high-risk vulnerabilities found"
            fi
          fi

  # æ€§èƒ½æµ‹è¯• (å¯é€‰)
  performance:
    name: Performance Test
    runs-on: ubuntu-latest
    needs: [build, test-mandatory]
    if: github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'performance-test')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Enable Corepack and Enforce Package Manager Version
        run: corepack enable

      - name: Install dependencies
        run: npm install

      - name: Run performance tests
        run: npx turbo run test:performance --filter=...[origin/main] || echo "No performance tests found"

  # æµ‹è¯•æŠ¥å‘Šç”Ÿæˆ
  test-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [test, test-mandatory]
    if: always() && (needs.test.result == 'success' || needs.test-mandatory.result == 'success')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Download test artifacts
        uses: actions/download-artifact@v4
        with:
          name: test-results
          path: test-results/
        continue-on-error: true

      - name: Generate test report
        run: node ./scripts/generate-test-report.js
        working-directory: ${{ github.workspace }}

      - name: Upload test report
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: test-results/report.html

  # æœ€ç»ˆçŠ¶æ€
  success:
    name: Pipeline Success
    runs-on: ubuntu-latest
    needs: [quality, test, contracts, build, test-mandatory, security, test-report]
    if: needs.quality.result == 'success' && needs.test.result == 'success' && needs.contracts.result == 'success' && needs.build.result == 'success' && needs.test-mandatory.result == 'success' && needs.security.result == 'success'
    steps:
      - name: Pipeline Status
        run: |
          echo "âœ… All checks passed! Pipeline successful."
          echo "Quality: ${{ needs.quality.result }}"
          echo "Test: ${{ needs.test.result }}"
          echo "Contracts: ${{ needs.contracts.result }}"
          echo "Build: ${{ needs.build.result }}"
          echo "Test Mandatory: ${{ needs.test-mandatory.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Test Report: ${{ needs.test-report.result }}"