name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

# æˆäºˆå¿…è¦çš„æ¬Šé™ä»¥å‰µå»º PR è©•è«–
permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  NODE_VERSION: '20'
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ secrets.TURBO_TEAM }}

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Enable Corepack and Enforce Package Manager Version
        run: corepack enable

      - name: Install dependencies
        run: npm install --legacy-peer-deps --no-audit --no-fund

      - name: Lint check
        run: npx turbo run lint

      - name: Type check
        run: npx turbo run type-check

      - name: Check for build artifacts and sensitive files
        run: |
          echo "ğŸ” Checking for accidentally committed build artifacts and sensitive files..."
          
          # æ£€æŸ¥æ˜¯å¦æäº¤äº†æ„å»ºäº§ç‰©
          if git ls-files | grep -E "(node_modules|dist|\.turbo|build)/" | head -10; then
            echo "âŒ ERROR: Build artifacts detected in repository!"
            echo "The following build artifacts were found:"
            git ls-files | grep -E "(node_modules|dist|\.turbo|build)/" | head -20
            echo ""
            echo "Please remove these files and update .gitignore to prevent future commits."
            echo "Run: git rm -r --cached <file> for each file"
            exit 1
          else
            echo "âœ… No build artifacts found in repository"
          fi
          
          # æ£€æŸ¥æ˜¯å¦æäº¤äº†.envæ–‡ä»¶
          if git ls-files | grep -E "\.env" | head -10; then
            echo "âŒ ERROR: .env files detected in repository!"
            echo "The following .env files were found:"
            git ls-files | grep -E "\.env" | head -20
            echo ""
            echo "Please remove these files and ensure all configuration is externalized."
            echo "Use environment variables instead of .env files for production."
            exit 1
          else
            echo "âœ… No .env files found in repository"
          fi
          
          # æ£€æŸ¥æ˜¯å¦æäº¤äº†æ•æ„Ÿé…ç½®æ–‡ä»¶
          if git ls-files | grep -E "(secrets|credentials|keys)\.(json|yaml|yml|toml)$" | head -10; then
            echo "âŒ ERROR: Sensitive configuration files detected in repository!"
            echo "The following sensitive files were found:"
            git ls-files | grep -E "(secrets|credentials|keys)\.(json|yaml|yml|toml)$" | head -20
            echo ""
            echo "Please remove these files and use environment variables or secure secret management."
            exit 1
          else
            echo "âœ… No sensitive configuration files found in repository"
          fi

  # å•å…ƒæµ‹è¯•
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Enable Corepack and Enforce Package Manager Version
        run: corepack enable

      - name: Install dependencies
        run: npm install --legacy-peer-deps --no-audit --no-fund

      - name: Validate configuration
        run: |
          echo "ğŸ” éªŒè¯ç¯å¢ƒé…ç½®..."
          # æ£€æŸ¥å¿…è¦çš„ç¯å¢ƒå˜é‡æ˜¯å¦å­˜åœ¨
          if [ -z "$NODE_ENV" ]; then
            export NODE_ENV=test
          fi
          echo "âœ… é…ç½®éªŒè¯å®Œæˆ"

      - name: Run tests
        run: npx turbo run test
  # åˆåŒæ ¡éªŒ
  contracts:
    name: Contract Validation
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Enable Corepack and Enforce Package Manager Version
        run: corepack enable

      - name: Install dependencies
        run: npm install --legacy-peer-deps --no-audit --no-fund

      - name: Typecheck (contracts)
        run: npm run -w packages/contracts typecheck

      - name: Contracts tests with coverage gate
        run: npm run -w packages/contracts test:contracts:cov

      - name: Validate OpenAPI contracts
        run: |
          # æ£€æŸ¥ OpenAPI è¯­æ³•
          if [ -f packages/contracts/openapi.yaml ]; then
            echo "Validating OpenAPI contract..."
            # ä½¿ç”¨Node.js YAMLè§£æå™¨æ£€æŸ¥è¯­æ³•
            node -e "
              const fs = require('fs');
              const yaml = require('js-yaml');
              try {
                const content = fs.readFileSync('packages/contracts/openapi.yaml', 'utf8');
                yaml.load(content);
                console.log('âœ… OpenAPI YAML syntax is valid');
              } catch (e) {
                console.error('âŒ OpenAPI YAML syntax error:', e.message);
                process.exit(1);
              }
            " || echo "OpenAPI validation failed"
          else
            echo "OpenAPI file not found, skipping validation"
          fi
          
          # æ£€æŸ¥ Proto æ–‡ä»¶è¯­æ³•
          if command -v protoc &> /dev/null; then
            if [ -d packages/contracts/proto ]; then
              echo "Validating Proto files..."
              protoc --proto_path=packages/contracts/proto --js_out=import_style=commonjs,binary:. packages/contracts/proto/*.proto
              echo "âœ… Proto files validation completed"
            else
              echo "Proto directory not found, skipping validation"
            fi
          else
            echo "protoc not available, skipping proto validation"
          fi

