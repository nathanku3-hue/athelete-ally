name: Contract Check

on:
  pull_request:
    paths:
      - 'apps/frontend/src/app/api/**'
      - 'packages/shared-types/**'
      - 'apps/frontend/src/__tests__/contracts/**'
      - 'scripts/detect-contract-drift.js'
  push:
    branches: [main, develop]
    paths:
      - 'apps/frontend/src/app/api/**'
      - 'packages/shared-types/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  contract-check:
    name: Contract Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for emergency bypass
        id: check_bypass
        run: |
          PR_LABELS="${{ github.event.pull_request.labels.*.name }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_BRANCH="${{ github.head_ref }}"
          
          if [[ "$PR_LABELS" == *"allowcontractdrift"* ]]; then
            echo "âš ï¸ Emergency bypass label detected. Skipping contract checks."
            echo "bypass=true" >> $GITHUB_OUTPUT
            echo "::warning::Contract checks bypassed due to allowcontractdrift label. This should be audited and removed after addressing the issue."
            echo "::notice::Bypass Details: PR #$PR_NUMBER - $PR_TITLE"
            echo "::notice::Bypass Author: $PR_AUTHOR"
            echo "::notice::Bypass Timestamp: $(date -u)"
            echo "::notice::Bypass Branch: $PR_BRANCH"
          else
            echo "bypass=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.check_bypass.outputs.bypass == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: '20.18.0'
          cache: 'npm'

      - name: Install dependencies
        if: steps.check_bypass.outputs.bypass == 'false'
        run: npm ci --no-audit --no-fund

      - name: Type check
        if: steps.check_bypass.outputs.bypass == 'false'
        run: |
          echo "ğŸ” Running TypeScript type check..."
          npx tsc --noEmit --project apps/frontend/tsconfig.json
          echo "âœ… TypeScript type check passed"

      - name: Build check
        if: steps.check_bypass.outputs.bypass == 'false'
        run: |
          echo "ğŸ”¨ Running Next.js build check..."
          npm run build
          echo "âœ… Next.js build check passed"

      - name: Contract drift detection
        if: steps.check_bypass.outputs.bypass == 'false'
        run: |
          echo "ğŸ” Running contract drift detection..."
          node scripts/detect-contract-drift.js
          echo "âœ… Contract drift detection passed"

      - name: Contract tests
        if: steps.check_bypass.outputs.bypass == 'false'
        run: |
          echo "ğŸ§ª Running contract tests..."
          npm test -- apps/frontend/src/__tests__/contracts/type-consistency.test.ts
          echo "âœ… Contract tests passed"

      - name: Runtime validation test
        if: steps.check_bypass.outputs.bypass == 'false'
        run: |
          echo "ğŸ”§ Testing runtime validation..."
          node scripts/validate-contracts.js
          echo "âœ… Runtime validation test passed"

      - name: Check for stray literals
        if: steps.check_bypass.outputs.bypass == 'false'
        run: |
          echo "ğŸ” Checking for stray literals..."

          # Check for 'normal' fatigue level
          if grep -r "'normal'" apps/frontend/src --exclude-dir=node_modules --exclude-dir=.next --exclude="*.test.ts" --exclude="*.d.ts"; then
            echo "âŒ Found 'normal' fatigue level literals. Use 'moderate' from shared types."
            exit 1
          fi

          # Check for hyphenated seasons
          if grep -r "'off-season'\|'pre-season'\|'in-season'" apps/frontend/src --exclude-dir=node_modules --exclude-dir=.next --exclude="*.test.ts" --exclude="*.d.ts"; then
            echo "âŒ Found hyphenated season literals. Use 'offseason', 'preseason', 'inseason' from shared types."
            exit 1
          fi

          echo "âœ… No stray literals found"

      - name: Verify shared type imports
        if: steps.check_bypass.outputs.bypass == 'false'
        run: |
          echo "ğŸ” Verifying shared type imports..."

          # Check that API routes import from shared types
          for file in apps/frontend/src/app/api/**/*.ts; do
            if [[ -f "$file" ]]; then
              if ! grep -q "@athlete-ally/shared-types" "$file"; then
                echo "âŒ $file should import from @athlete-ally/shared-types"
                exit 1
              fi
            fi
          done

          echo "âœ… Shared type imports verified"

      - name: Summary
        if: always()
        run: |
          echo "ğŸ“Š Contract Check Summary"
          echo "========================"
          BYPASS_STATUS="${{ steps.check_bypass.outputs.bypass }}"
          if [[ "$BYPASS_STATUS" == "true" ]]; then
            echo "âš ï¸ Contract checks BYPASSED due to allowcontractdrift label"
            echo "ğŸ” This bypass should be audited and removed after addressing the issue"
            echo "ğŸ“‹ Bypass reason: Emergency contract drift allowance"
            echo "â° Bypass timestamp: $(date)"
            echo "ğŸ‘¤ Bypass author: ${{ github.event.pull_request.user.login }}"
            echo "ğŸ”— PR: #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}"
            echo "ğŸŒ¿ Branch: ${{ github.head_ref }}"
            echo ""
            echo "ğŸš¨ AUDIT REQUIRED: This bypass must be reviewed and removed after issue resolution"
          else
            echo "âœ… TypeScript compilation"
            echo "âœ… Next.js build"
            echo "âœ… Contract drift detection"
            echo "âœ… Contract tests"
            echo "âœ… Runtime validation"
            echo "âœ… Stray literal check"
            echo "âœ… Shared type imports"
            echo "ğŸ‰ All contract checks passed!"
          fi
          echo "========================"
