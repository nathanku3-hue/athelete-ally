# ===========================================
# Phase 3 Staging Environment Configuration
# Multi-Stream Migration - Staging Deployment
# ===========================================
#
# This configuration enables multi-stream mode for staging environment.
# Services will use AA_CORE_HOT, AA_VENDOR_HOT, and AA_DLQ streams.
#
# Prerequisites:
#   1. Run create-streams.js to create streams
#   2. Run create-consumers.js to create consumers
#   3. Verify streams exist before deploying services
#
# Rollback:
#   Set EVENT_STREAM_MODE=single to revert to legacy ATHLETE_ALLY_EVENTS stream
#
# ===========================================

# ===========================================
# Event Bus Configuration
# ===========================================

# Stream Mode: 'single' (legacy) or 'multi' (new topology)
# Phase 3 Migration: Set to 'multi' for staging
EVENT_STREAM_MODE=multi

# Stream Management
# false = Services do NOT create/manage streams (recommended for staging/prod)
# true = Services create/manage streams (dev only)
FEATURE_SERVICE_MANAGES_STREAMS=false

# Consumer Management
# false = Services bind to pre-existing consumers (recommended for staging/prod)
# true = Services create/manage consumers (dev only)
FEATURE_SERVICE_MANAGES_CONSUMERS=false

# NATS Connection
NATS_URL=nats://staging-nats:4222

# Stream Names (optional overrides)
# Defaults: AA_CORE_HOT, AA_VENDOR_HOT, AA_DLQ, ATHLETE_ALLY_EVENTS
# STREAM_CORE_NAME=AA_CORE_HOT
# STREAM_VENDOR_NAME=AA_VENDOR_HOT
# STREAM_DLQ_NAME=AA_DLQ
# STREAM_LEGACY_NAME=ATHLETE_ALLY_EVENTS

# ===========================================
# Service-Specific Configuration
# ===========================================

# --- Ingest Service ---
INGEST_PORT=4101
INGEST_HOST=0.0.0.0

# --- Normalize Service ---
NORMALIZE_PORT=4102
NORMALIZE_HOST=0.0.0.0

# HRV Consumer Configuration
NORMALIZE_HRV_DURABLE=normalize-hrv-durable
NORMALIZE_HRV_MAX_DELIVER=5
NORMALIZE_HRV_DLQ_SUBJECT=dlq.normalize.hrv.raw-received
NORMALIZE_HRV_ACK_WAIT_MS=60000

# Oura Consumer Configuration
NORMALIZE_DURABLE_NAME=normalize-oura
NORMALIZE_OURA_MAX_DELIVER=5
NORMALIZE_DLQ_SUBJECT=dlq.vendor.oura.webhook
NORMALIZE_OURA_ACK_WAIT_MS=15000

# --- Database Configuration ---
# Normalize Service Database
DATABASE_URL=postgresql://athlete:CHANGEME@staging-db:5432/athlete_normalize

# --- Telemetry Configuration ---
TELEMETRY_ENABLED=true
OTEL_TRACES_EXPORTER=otlp
OTEL_METRICS_EXPORTER=prometheus
OTEL_EXPORTER_OTLP_ENDPOINT=http://staging-otel-collector:4318

# Prometheus Metrics
PROMETHEUS_PORT=9464
PROMETHEUS_ENDPOINT=/metrics

# ===========================================
# Monitoring and Alerting
# ===========================================

# Log Level
LOG_LEVEL=info
LOG_FORMAT=json

# Health Check
HEALTH_CHECK_INTERVAL=30000

# ===========================================
# Deployment Notes
# ===========================================
#
# Pre-Deployment Checklist:
#   [ ] AA_CORE_HOT stream exists
#   [ ] AA_VENDOR_HOT stream exists
#   [ ] AA_DLQ stream exists
#   [ ] normalize-hrv-durable consumer exists on AA_CORE_HOT
#   [ ] Monitoring dashboards updated with stream labels
#   [ ] Alert rules configured for DLQ monitoring
#
# Post-Deployment Verification:
#   [ ] Service logs show: "Stream mode: multi"
#   [ ] Service logs show: "Found existing HRV consumer on AA_CORE_HOT"
#   [ ] Metrics endpoint shows: normalize_hrv_messages_total{stream="AA_CORE_HOT"}
#   [ ] Database inserts continue (no data loss)
#   [ ] DLQ message count stable (no spikes)
#
# Rollback Procedure:
#   1. Set EVENT_STREAM_MODE=single
#   2. Restart services
#   3. Verify logs show: "Stream mode: single"
#   4. Verify logs show: "Stream candidates: ATHLETE_ALLY_EVENTS"
#
# ===========================================
