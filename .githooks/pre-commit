#!/usr/bin/env bash
set -euo pipefail

CHANGED=$(git diff --cached --name-only --diff-filter=ACM || true)
if [ -z "$CHANGED" ]; then
  exit 0
fi

HAS_WORKFLOW=false
for f in $CHANGED; do
  case "$f" in
    .github/workflows/*.yml) HAS_WORKFLOW=true ;; 
  esac
done

if $HAS_WORKFLOW; then
  echo "üîé Running actionlint on changed workflows..."
  if command -v actionlint >/dev/null 2>&1; then
    actionlint -color
  else
    echo "‚ö†Ô∏è actionlint not available locally, attempting to fetch..."
    if npx -y @actionlint/cli@1.7.7 -color 2>/dev/null; then
      echo "‚úÖ actionlint validation passed"
    else
      echo "‚ö†Ô∏è actionlint fetch failed or validation failed - continuing anyway"
      echo "‚ÑπÔ∏è CI will perform authoritative validation"
    fi
  fi
fi

SHELL_FILES=$(echo "$CHANGED" | grep -E '\\.sh$' || true)
if [ -n "$SHELL_FILES" ]; then
  if command -v shellcheck >/dev/null 2>&1; then
    echo "üîé Running shellcheck on changed shell scripts..."
    # shellcheck disable=SC2086
    shellcheck $SHELL_FILES
  else
    echo "‚ÑπÔ∏è shellcheck not installed; skipping shell script lint"
  fi
fi

exit 0