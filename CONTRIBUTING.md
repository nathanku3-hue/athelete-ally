# The Ally Workflow - 工程宪法

**版本**: 1.0  
**最后更新**: 2025-01-27  
**适用范围**: Athlete Ally 项目全体开发团队

---

## 🎯 工作流概述

The Ally Workflow 是我们团队的核心开发标准，确保从功能构思到生产部署的每一个环节都经过科学化、标准化的处理。本工作流基于"合同优先"和"测试驱动"的开发理念，结合自动化CI/CD和预览环境，实现高质量、高效率的软件开发。

### 核心原则
- **合同优先**: API契约先行，确保前后端解耦
- **测试驱动**: 测试先行，保证代码质量
- **自动化优先**: 最大化利用CI/CD，减少手动操作
- **预览环境**: 每个PR都有独立的测试环境

---

## 📋 四个核心阶段

### 1️⃣ 准备阶段 (Preparation Phase)
**目标**: 从PRD到技术评审的完整准备

### 2️⃣ 开发阶段 (Development Phase)  
**目标**: 合同优先和测试驱动的开发流程

### 3️⃣ 审查阶段 (Review Phase)
**目标**: 自动化CI/CD和预览环境验证

### 4️⃣ 发布阶段 (Release Phase)
**目标**: 生产部署和监控验证

---

## 1️⃣ 准备阶段 (Preparation Phase)

### 1.1 需求分析
**输入**: PRD文档、用户故事  
**输出**: 技术需求文档

#### 1.1.1 PRD审查
- [ ] 确认用户故事完整性
- [ ] 验证业务逻辑清晰度
- [ ] 识别技术边界和约束
- [ ] 评估开发复杂度

#### 1.1.2 技术需求定义
- [ ] 确定API接口需求
- [ ] 定义数据模型变更
- [ ] 识别外部依赖
- [ ] 评估性能要求

### 1.2 架构设计
**输入**: 技术需求文档  
**输出**: 技术设计文档

#### 1.2.1 系统设计
- [ ] 绘制系统架构图
- [ ] 定义服务边界
- [ ] 设计数据流
- [ ] 确定技术栈选择

#### 1.2.2 API设计
- [ ] 设计REST API接口
- [ ] 定义请求/响应格式
- [ ] 创建OpenAPI规范
- [ ] 设计错误处理机制

### 1.3 合同定义
**输入**: API设计  
**输出**: 服务合同

#### 1.3.1 前端-后端合同
- [ ] 定义Gateway BFF接口
- [ ] 创建TypeScript类型定义
- [ ] 生成Mock数据
- [ ] 验证合同完整性

#### 1.3.2 微服务间合同
- [ ] 定义gRPC/HTTP接口
- [ ] 创建Proto文件
- [ ] 定义事件契约
- [ ] 建立服务发现机制

### 1.4 技术评审
**输入**: 技术设计文档、服务合同  
**输出**: 评审通过确认

#### 1.4.1 设计评审
- [ ] 架构合理性审查
- [ ] 性能影响评估
- [ ] 安全性检查
- [ ] 可维护性评估

#### 1.4.2 合同评审
- [ ] API设计合理性
- [ ] 类型定义完整性
- [ ] 向后兼容性检查
- [ ] 错误处理完整性

---

## 2️⃣ 开发阶段 (Development Phase)

### 2.1 环境准备
**输入**: 技术评审通过确认  
**输出**: 开发环境就绪

#### 2.1.1 分支策略
- [ ] 从`develop`创建功能分支
- [ ] 分支命名: `feature/US-XXX-description`
- [ ] 设置分支保护规则
- [ ] 配置CI/CD触发

#### 2.1.2 开发环境
- [ ] 启动本地开发环境: `npm run preview:up`
- [ ] 验证所有服务正常运行
- [ ] 确认数据库连接
- [ ] 测试基础功能

### 2.2 合同实现
**输入**: 服务合同  
**输出**: 合同实现完成

#### 2.2.1 后端合同实现
- [ ] 实现API接口
- [ ] 添加输入验证
- [ ] 实现错误处理
- [ ] 添加API文档

#### 2.2.2 前端合同实现
- [ ] 实现API客户端
- [ ] 添加类型定义
- [ ] 实现错误处理
- [ ] 添加加载状态

### 2.3 测试驱动开发
**输入**: 合同实现  
**输出**: 测试覆盖的代码

#### 2.3.1 单元测试
- [ ] 编写服务层测试
- [ ] 编写组件测试
- [ ] 编写工具函数测试
- [ ] 确保测试覆盖率 > 80%

**测试工具使用**:
- 使用 `@contracts-test-utils/helpers` 中的泛型测试工具
- 使用 `@contracts-test-utils/types` 中的类型定义
- 示例: `import { simulateApiCall } from '@contracts-test-utils/helpers'`

#### 2.3.2 集成测试
- [ ] 编写API集成测试
- [ ] 编写数据库集成测试
- [ ] 编写服务间通信测试
- [ ] 验证端到端流程

#### 2.3.3 测试执行
- [ ] 本地运行测试: `npm run test:all`
- [ ] 修复失败的测试
- [ ] 验证测试覆盖率
- [ ] 确保所有测试通过

### 2.4 代码实现
**输入**: 测试用例  
**输出**: 功能完整的代码

#### 2.4.1 业务逻辑实现
- [ ] 实现核心业务逻辑
- [ ] 添加数据验证
- [ ] 实现错误处理
- [ ] 添加日志记录

#### 2.4.2 用户界面实现
- [ ] 实现React组件
- [ ] 添加样式和交互
- [ ] 实现响应式设计
- [ ] 添加无障碍支持

### 2.5 代码质量检查
**输入**: 功能代码  
**输出**: 质量检查通过

#### 2.5.1 静态分析
- [ ] 运行ESLint: `npm run lint`
- [ ] 运行TypeScript检查: `npm run type-check`
- [ ] 修复代码风格问题
- [ ] 确保无TypeScript错误

#### 2.5.2 代码审查
- [ ] 自我代码审查
- [ ] 检查代码重复
- [ ] 验证命名规范
- [ ] 确保注释完整性

---

## 3️⃣ 审查阶段 (Review Phase)

### 3.1 自动化CI/CD
**输入**: 代码提交  
**输出**: CI/CD管道通过

#### 3.1.1 代码质量检查
- [ ] 自动运行ESLint检查
- [ ] 自动运行TypeScript检查
- [ ] 自动运行单元测试
- [ ] 自动运行安全扫描

#### 3.1.2 构建验证
- [ ] 自动构建所有服务
- [ ] 验证Docker镜像构建
- [ ] 检查构建产物完整性
- [ ] 验证环境变量配置

### 3.2 预览环境部署
**输入**: 构建成功  
**输出**: 预览环境就绪

#### 3.2.1 环境部署
- [ ] 自动部署到预览环境
- [ ] 启动所有微服务
- [ ] 验证服务健康状态
- [ ] 配置监控和日志

#### 3.2.2 环境验证
- [ ] 验证前端访问正常
- [ ] 验证API接口可用
- [ ] 验证数据库连接
- [ ] 验证服务间通信

### 3.3 集成测试
**输入**: 预览环境就绪  
**输出**: 集成测试通过

#### 3.3.1 自动化测试
- [ ] 运行端到端测试
- [ ] 运行性能测试
- [ ] 运行安全测试
- [ ] 验证API合同

#### 3.3.2 手动测试
- [ ] 功能完整性测试
- [ ] 用户体验测试
- [ ] 边界条件测试
- [ ] 错误场景测试

### 3.4 代码审查
**输入**: 测试通过  
**输出**: 代码审查通过

#### 3.4.1 同行评审
- [ ] 至少一名同事审查
- [ ] 检查代码逻辑正确性
- [ ] 验证测试覆盖度
- [ ] 确认文档完整性

#### 3.4.2 架构审查
- [ ] 检查架构一致性
- [ ] 验证性能影响
- [ ] 确认安全性
- [ ] 评估可维护性

---

## 4️⃣ 发布阶段 (Release Phase)

### 4.1 发布准备
**输入**: 代码审查通过  
**输出**: 发布就绪

#### 4.1.1 版本管理
- [ ] 更新版本号
- [ ] 更新CHANGELOG
- [ ] 创建发布标签
- [ ] 准备发布说明

#### 4.1.2 环境配置
- [ ] 配置生产环境变量
- [ ] 验证数据库迁移
- [ ] 检查外部服务配置
- [ ] 准备回滚计划

### 4.2 生产部署
**输入**: 发布就绪  
**输出**: 生产环境部署完成

#### 4.2.1 部署执行
- [ ] 执行生产部署
- [ ] 验证服务启动
- [ ] 检查健康状态
- [ ] 验证功能正常

#### 4.2.2 部署验证
- [ ] 运行冒烟测试
- [ ] 验证关键功能
- [ ] 检查性能指标
- [ ] 确认监控正常

### 4.3 监控和验证
**输入**: 部署完成  
**输出**: 生产环境稳定

#### 4.3.1 实时监控
- [ ] 监控服务状态
- [ ] 检查错误日志
- [ ] 验证性能指标
- [ ] 监控用户反馈

#### 4.3.2 问题处理
- [ ] 快速响应问题
- [ ] 执行回滚（如需要）
- [ ] 记录问题原因
- [ ] 制定改进计划

---

## 🛠️ 开发工具和脚本

### 本地开发环境
```bash
# 启动完整开发环境
npm run preview:up

# 停止开发环境
npm run preview:down

# 运行所有测试
npm run test:all

# 运行端到端测试
npm run test:e2e

# 构建所有服务
npm run build:all
```

### 代码质量工具
```bash
# 代码检查
npm run lint

# 类型检查
npm run type-check

# 安全审计
npm audit
```

### 数据库管理
```bash
# 生成Prisma客户端
npx turbo run db:generate

# 运行数据库迁移
npx turbo run db:migrate
```

---

## 📊 质量指标

### 代码质量
- **测试覆盖率**: > 80%
- **TypeScript错误**: 0
- **ESLint警告**: < 5
- **代码重复率**: < 5%

### 性能指标
- **页面加载时间**: < 2秒
- **API响应时间**: < 500ms
- **数据库查询时间**: < 100ms
- **内存使用**: < 512MB

### 安全指标
- **安全漏洞**: 0 (高危)
- **依赖漏洞**: 0 (高危)
- **敏感信息泄露**: 0
- **认证失败率**: < 1%

---

## 🚨 应急处理

### 生产问题
1. **立即响应**: 5分钟内响应
2. **问题诊断**: 15分钟内定位
3. **临时修复**: 30分钟内实施
4. **根本修复**: 24小时内完成

### 回滚策略
1. **自动回滚**: 关键指标异常时自动触发
2. **手动回滚**: 通过CI/CD管道执行
3. **数据回滚**: 数据库状态回滚
4. **服务回滚**: 服务版本回滚

---

## 📚 相关文档

- [项目架构文档](./docs/v3-architecture-design.md)
- [API文档](./API_ENDPOINTS_OVERVIEW.md)
- [部署指南](./README.md)
- [测试指南](./tests/README.md)

---

## 🤝 贡献指南

### 提交代码
1. 遵循本工作流的所有阶段
2. 确保所有检查通过
3. 提供清晰的提交信息
4. 关联相关Issue

### 问题报告
1. 使用标准模板
2. 提供复现步骤
3. 包含环境信息
4. 添加相关日志

### 功能请求
1. 先创建Issue讨论
2. 提供详细需求描述
3. 考虑技术可行性
4. 评估影响范围

---

**记住**: The Ally Workflow 是我们团队的质量保证，每一个步骤都是为了确保我们交付的代码是高质量、可维护、可扩展的。遵循这个工作流，我们就能持续交付价值，同时保持代码库的健康状态。

## 测试规范（统一约定）

- 优先使用“泛型 helpers”与统一结果形状
  - 统一结果：`type ApiResponse<T> = { ok: true; data: T } | { ok: false; error: unknown }`
  - 工具：`ok/err/fromPromise/isOk/unwrap/map`（见各包 `packages/<pkg>/tests/test-utils`，或别名 `@<pkg>-test-utils/*`）
  - 在测试中先判断 `ok` 再访问 `data`，失败分支断言 `error`
- 运行时校验：关键 I/O 边界使用 zod 解析断言
  - 共享 Schema 位于 `packages/shared-types/src/schemas/*`
  - 断言示例：`const parsed = Schema.safeParse(json); expect(parsed.success).toBe(true)`
  - 仅在必要时做解析断言；内部纯计算可只用 TS 类型
- 模拟工具：优先复用已有 helpers 而非重复造轮子
  - `simulateApiCall/simulateServiceFailure/simulateRetryOperation` 等位于 `packages/contracts/tests/test-utils`
  - 进阶：必要时新增通用 helper，放到对应包的 `tests/test-utils`
- 断言不要“收窄/脆弱”（Do not over‑specify）
  - 避免对完整对象做 `deepEqual` 或严格字段枚举；优先断言形状/必要字段/关键约束
  - 示例：`expect(arr).toHaveLength(>=1)`、`expect(item).toHaveProperty('id')`、`expect(value).toBeGreaterThan(0)`
- 类型与安全：
  - 测试默认遵守 `@typescript-eslint/no-unsafe-*` 规则（必要处可局部 disable 并写明原因）
  - 避免 `any`；使用 z.infer 同步类型：`type T = z.infer<typeof Schema>`
- 受影响测试与本地校验：
  - 仅跑受影响用例：`jest -o` 或 `jest --findRelatedTests`
  - 本地严格检查：`npm run lint:tests:strict`、类型覆盖率：`npm run type:coverage:*`
  - 预提交已启用 Husky + lint-staged：自动执行 eslint 修复、受影响测试、变更范围 type-check
