#!/bin/bash

# ???????
# ???????????RLS??

set -e

echo "??? ???????????..."

# ?? Docker ????
if ! docker info > /dev/null 2>&1; then
    echo "? Docker ???????? Docker"
    exit 1
fi

# ?? PostgreSQL ????
if ! docker ps | grep -q postgres; then
    echo "?? ?? PostgreSQL ???..."
    docker-compose -f ../preview.compose.yaml up -d postgres
    sleep 10
fi

# ???????
echo "? ???????..."
until docker exec postgres pg_isready -U athlete -d athlete; do
  echo "???????..."
  sleep 2
done

echo "? ??????"

# ?????
echo "?? ?????..."
docker exec postgres psql -U athlete -d athlete -c "
CREATE DATABASE IF NOT EXISTS athlete_ally_main;
CREATE DATABASE IF NOT EXISTS athlete_ally_config;
CREATE DATABASE IF NOT EXISTS athlete_ally_profiles;
CREATE DATABASE IF NOT EXISTS athlete_ally_plans;
CREATE DATABASE IF NOT EXISTS athlete_ally_fatigue;
CREATE DATABASE IF NOT EXISTS athlete_ally_notifications;
"

# ?? RLS ??
echo "?? ?? RLS ??..."
docker exec -i postgres psql -U athlete -d athlete_ally_main < rls-policies.sql

# ???????
echo "?? ???????..."
docker exec postgres psql -U athlete -d athlete_ally_main -c "
CREATE USER IF NOT EXISTS athlete_ally_user WITH PASSWORD 'athlete_ally_password';
GRANT ALL PRIVILEGES ON DATABASE athlete_ally_main TO athlete_ally_user;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO athlete_ally_user;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO athlete_ally_user;
"

# ???????
echo "?? ???????..."
if [ -f "../prisma/schema.prisma" ]; then
    echo "?? Prisma ??..."
    npx prisma migrate deploy
fi

# ???????
echo "?? ???????..."
docker exec postgres pg_dump -U athlete -d athlete_ally_main > database-backup-$(date +%Y%m%d-%H%M%S).sql

# ???????
echo ""
echo "?? ????????"
echo "   ??: localhost"
echo "   ??: 5432"
echo "   ??: athlete_ally_user"
echo "   ??: athlete_ally_password"
echo "   ???: athlete_ally_main"
echo ""

# ?? RLS ??
echo "?? RLS ?????"
docker exec postgres psql -U athlete -d athlete_ally_main -c "SELECT * FROM check_rls_status();"

# ??????
echo "?? ??????..."
docker exec postgres psql -U athlete -d athlete_ally_main -c "
SELECT set_config('app.current_user_id', '11111111-1111-1111-1111-111111111111', true);
SELECT * FROM user_permissions LIMIT 5;
"

echo ""
echo "?? ????????"
echo "?? ?????????????????? A"

