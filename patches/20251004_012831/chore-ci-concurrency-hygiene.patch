From eb20c0b097a1e475ac1e7f59bd081d291667639d Mon Sep 17 00:00:00 2001
From: Release Bot <release-bot@local>
Date: Sat, 4 Oct 2025 01:21:07 +0800
Subject: [PATCH 1/2] ci: concurrency hygiene + use local lint:ci

- Add top-level concurrency groups (cancel-in-progress) where missing
- Replace 'npx eslint' with 'npm run lint:ci' (compact formatter)
---
 .github/workflows/_prisma-generate-reuse.yml | 4 ++++
 .github/workflows/_sanity-reuse.yml          | 4 ++++
 .github/workflows/alpha-smoke.yml            | 4 ++++
 .github/workflows/backend-deploy.yml         | 4 ++++
 .github/workflows/boundaries-check.yml       | 4 ++--
 .github/workflows/branch-protection.yml      | 4 ++++
 .github/workflows/cache-diagnostics.yml      | 4 ++++
 .github/workflows/ci-diagnostics.yml         | 4 ++++
 .github/workflows/ci-guards.yml              | 4 ++++
 .github/workflows/ci.yml                     | 2 +-
 .github/workflows/contracts-guard.yml        | 4 ++++
 .github/workflows/env-guard.yml              | 4 ++++
 .github/workflows/large-files-guard.yml      | 4 ++++
 .github/workflows/lockfile-rehydrate.yml     | 4 ++++
 .github/workflows/prisma-migration-guard.yml | 4 ++++
 .github/workflows/test-manual.yml            | 4 ++++
 package.json                                 | 3 ++-
 17 files changed, 61 insertions(+), 4 deletions(-)

diff --git a/.github/workflows/_prisma-generate-reuse.yml b/.github/workflows/_prisma-generate-reuse.yml
index e2d8606..d3fbf7d 100644
--- a/.github/workflows/_prisma-generate-reuse.yml
+++ b/.github/workflows/_prisma-generate-reuse.yml
@@ -35,3 +35,7 @@ jobs:
           echo "‚úÖ All Prisma clients generated"
         env:
           PRISMA_ENGINES_MIRROR: ${{ secrets.PRISMA_ENGINES_MIRROR }}
+
+concurrency:
+  group: ${{ github.workflow }}-${{ github.ref }}
+  cancel-in-progress: true
\ No newline at end of file
diff --git a/.github/workflows/_sanity-reuse.yml b/.github/workflows/_sanity-reuse.yml
index 87d3bba..46bc6d1 100644
--- a/.github/workflows/_sanity-reuse.yml
+++ b/.github/workflows/_sanity-reuse.yml
@@ -73,3 +73,7 @@ jobs:
             git ls-files -- '**/package-lock.json' || find . -type f -name 'package-lock.json' -not -path './node_modules/*'
             echo "EOF"
           } >> "${GITHUB_OUTPUT}"
+
+concurrency:
+  group: ${{ github.workflow }}-${{ github.ref }}
+  cancel-in-progress: true
\ No newline at end of file
diff --git a/.github/workflows/alpha-smoke.yml b/.github/workflows/alpha-smoke.yml
index 572dacc..e8ec006 100644
--- a/.github/workflows/alpha-smoke.yml
+++ b/.github/workflows/alpha-smoke.yml
@@ -48,3 +48,7 @@ jobs:
           compression-level: 6
           overwrite: true
 
+
+concurrency:
+  group: ${{ github.workflow }}-${{ github.ref }}
+  cancel-in-progress: true
\ No newline at end of file
diff --git a/.github/workflows/backend-deploy.yml b/.github/workflows/backend-deploy.yml
index afed940..2b11717 100644
--- a/.github/workflows/backend-deploy.yml
+++ b/.github/workflows/backend-deploy.yml
@@ -72,3 +72,7 @@ jobs:
           echo "Deploying to production..."
           # ???????????
 
+
+concurrency:
+  group: ${{ github.workflow }}-${{ github.ref }}
+  cancel-in-progress: true
\ No newline at end of file
diff --git a/.github/workflows/boundaries-check.yml b/.github/workflows/boundaries-check.yml
index 448f250..220f2d8 100644
--- a/.github/workflows/boundaries-check.yml
+++ b/.github/workflows/boundaries-check.yml
@@ -62,7 +62,7 @@ jobs:
           # Run ESLint with error-level boundary rules on changed files only
           # Allow: relative imports (./** ../**), monorepo packages (@athlete-ally/**), Next.js aliases (@/**), dotenv
           echo "üö® Running strict boundary checks on changed files..."
-          npx eslint --no-error-on-unmatched-pattern --max-warnings=0 \
+          npm run lint:ci
             "$(printf "%s" "${CHANGED_FILES}")" \
             --rule "import/no-internal-modules: [error, { allow: [\"./**\", \"../**\", \"@athlete-ally/**\", \"@/**\", \"dotenv/config\"] }]" \
             --rule "no-restricted-imports: error" \
@@ -74,7 +74,7 @@ jobs:
         continue-on-error: true
         run: |
           mkdir -p reports/deps
-          npx eslint . -f json > reports/deps/eslint-boundaries-strict.json || echo "ESLint boundaries report generated with warnings"
+          npm run lint:ci
 
       - name: Upload Boundaries Report
         if: always()
diff --git a/.github/workflows/branch-protection.yml b/.github/workflows/branch-protection.yml
index d63492c..e860013 100644
--- a/.github/workflows/branch-protection.yml
+++ b/.github/workflows/branch-protection.yml
@@ -60,3 +60,7 @@ jobs:
           
           echo "‚úÖ ÂàÜÊîØ‰øùÊä§ËßÑÂàôËÆæÁΩÆÂÆåÊàêÔºÅ"
           echo "Âèó‰øùÊä§ÁöÑÊ£ÄÊü•Ôºö${{ github.event.inputs.required_status_checks }}"
+
+concurrency:
+  group: ${{ github.workflow }}-${{ github.ref }}
+  cancel-in-progress: true
\ No newline at end of file
diff --git a/.github/workflows/cache-diagnostics.yml b/.github/workflows/cache-diagnostics.yml
index 1a69be5..fa97a54 100644
--- a/.github/workflows/cache-diagnostics.yml
+++ b/.github/workflows/cache-diagnostics.yml
@@ -81,3 +81,7 @@ jobs:
           echo "NPM version: $(npm --version)"
           echo "Available disk space:"
           df -h
+
+concurrency:
+  group: ${{ github.workflow }}-${{ github.ref }}
+  cancel-in-progress: true
\ No newline at end of file
diff --git a/.github/workflows/ci-diagnostics.yml b/.github/workflows/ci-diagnostics.yml
index e45ca28..80146d9 100644
--- a/.github/workflows/ci-diagnostics.yml
+++ b/.github/workflows/ci-diagnostics.yml
@@ -104,3 +104,7 @@ jobs:
         run: |
           npm run build
 
+
+concurrency:
+  group: ${{ github.workflow }}-${{ github.ref }}
+  cancel-in-progress: true
\ No newline at end of file
diff --git a/.github/workflows/ci-guards.yml b/.github/workflows/ci-guards.yml
index 7a2b622..b1ecf09 100644
--- a/.github/workflows/ci-guards.yml
+++ b/.github/workflows/ci-guards.yml
@@ -20,3 +20,7 @@ jobs:
       - name: Check tsconfig drift
         run: node scripts/ci/check-tsconfig-drift.cjs
 
+
+concurrency:
+  group: ${{ github.workflow }}-${{ github.ref }}
+  cancel-in-progress: true
\ No newline at end of file
diff --git a/.github/workflows/ci.yml b/.github/workflows/ci.yml
index 2f123bd..381595b 100644
--- a/.github/workflows/ci.yml
+++ b/.github/workflows/ci.yml
@@ -122,7 +122,7 @@ jobs:
         continue-on-error: true
         run: |
           mkdir -p reports/deps
-          npx eslint . -f json > reports/deps/eslint-boundaries.json || echo "ESLint boundaries report generated with warnings"
+          npm run lint:ci
 
       - name: Upload Boundaries Report
         if: always()
diff --git a/.github/workflows/contracts-guard.yml b/.github/workflows/contracts-guard.yml
index f469e86..f6fafc9 100644
--- a/.github/workflows/contracts-guard.yml
+++ b/.github/workflows/contracts-guard.yml
@@ -83,3 +83,7 @@ jobs:
         run: |
           echo "‚ÑπÔ∏è  This is a non-blocking check for now"
           echo "It will be promoted to blocking after monitoring a few successful runs"
+
+concurrency:
+  group: ${{ github.workflow }}-${{ github.ref }}
+  cancel-in-progress: true
\ No newline at end of file
diff --git a/.github/workflows/env-guard.yml b/.github/workflows/env-guard.yml
index 92d984c..333ad97 100644
--- a/.github/workflows/env-guard.yml
+++ b/.github/workflows/env-guard.yml
@@ -39,3 +39,7 @@ jobs:
           else
             echo "‚úÖ No .env files found (excluding examples)"
           fi
+
+concurrency:
+  group: ${{ github.workflow }}-${{ github.ref }}
+  cancel-in-progress: true
\ No newline at end of file
diff --git a/.github/workflows/large-files-guard.yml b/.github/workflows/large-files-guard.yml
index 8926e04..29eca99 100644
--- a/.github/workflows/large-files-guard.yml
+++ b/.github/workflows/large-files-guard.yml
@@ -65,3 +65,7 @@ jobs:
           else
             echo "‚úÖ No large tracked files found"
           fi
+
+concurrency:
+  group: ${{ github.workflow }}-${{ github.ref }}
+  cancel-in-progress: true
\ No newline at end of file
diff --git a/.github/workflows/lockfile-rehydrate.yml b/.github/workflows/lockfile-rehydrate.yml
index 79bcea8..b83bd39 100644
--- a/.github/workflows/lockfile-rehydrate.yml
+++ b/.github/workflows/lockfile-rehydrate.yml
@@ -60,3 +60,7 @@ jobs:
           path: |
             npm-debug.log
             **/npm-debug.log
+
+concurrency:
+  group: ${{ github.workflow }}-${{ github.ref }}
+  cancel-in-progress: true
\ No newline at end of file
diff --git a/.github/workflows/prisma-migration-guard.yml b/.github/workflows/prisma-migration-guard.yml
index 18fb2c2..047b2c4 100644
--- a/.github/workflows/prisma-migration-guard.yml
+++ b/.github/workflows/prisma-migration-guard.yml
@@ -120,3 +120,7 @@ jobs:
         run: |
           echo "üßπ Cleaning up test resources..."
           # Clean up any test databases or temporary files
+
+concurrency:
+  group: ${{ github.workflow }}-${{ github.ref }}
+  cancel-in-progress: true
\ No newline at end of file
diff --git a/.github/workflows/test-manual.yml b/.github/workflows/test-manual.yml
index 7751838..e5d16d5 100644
--- a/.github/workflows/test-manual.yml
+++ b/.github/workflows/test-manual.yml
@@ -18,3 +18,7 @@ jobs:
       - name: "Test step"
         run: |
           echo "Test workflow triggered with input: ${{ inputs.test_input }}"
+
+concurrency:
+  group: ${{ github.workflow }}-${{ github.ref }}
+  cancel-in-progress: true
\ No newline at end of file
diff --git a/package.json b/package.json
index 6a218ed..80e1907 100644
--- a/package.json
+++ b/package.json
@@ -84,7 +84,8 @@
     "dev:compose": "docker compose up --build",
     "dev:compose:obs": "docker compose --profile obs up --build",
     "lint:json": "node scripts/json-lint.js monitoring/grafana/dashboards/normalize-sleep.json docs/examples/soak_sleep_summary.example.json",
-    "lint:yaml": "node scripts/yaml-lint.js monitoring/alert_rules.yml"
+    "lint:yaml": "node scripts/yaml-lint.js monitoring/alert_rules.yml",
+    "lint:ci": "eslint . -f compact"
   },
   "dependencies": {
     "@radix-ui/react-dialog": "^1.1.15",
-- 
2.50.0.windows.1


From 9bbcfb64e943e3e85b1f7e59d6e183bbd4e93280 Mon Sep 17 00:00:00 2001
From: Release Bot <release-bot@local>
Date: Sat, 4 Oct 2025 01:22:28 +0800
Subject: [PATCH 2/2] ci: dashboards determinism report workflow (non-blocking)

---
 .github/workflows/dashboards-determinism.yml | 30 +++++++++++
 scripts/ops/check-grafana-index.mjs          | 52 ++++++++++++++++++++
 2 files changed, 82 insertions(+)
 create mode 100644 .github/workflows/dashboards-determinism.yml
 create mode 100644 scripts/ops/check-grafana-index.mjs

diff --git a/.github/workflows/dashboards-determinism.yml b/.github/workflows/dashboards-determinism.yml
new file mode 100644
index 0000000..4edfa8c
--- /dev/null
+++ b/.github/workflows/dashboards-determinism.yml
@@ -0,0 +1,30 @@
+name: Dashboards Determinism (Report)
+
+on:
+  pull_request:
+  push:
+    branches: [ main ]
+
+concurrency:
+  group: ${{ github.workflow }}-${{ github.ref }}
+  cancel-in-progress: true
+
+jobs:
+  dashboards-determinism:
+    name: Dashboards Index Determinism (report-only)
+    runs-on: ubuntu-latest
+    steps:
+      - uses: actions/checkout@v4
+      - uses: actions/setup-node@v4
+        with:
+          node-version: '20.18.x'
+      - name: Run check
+        run: |
+          node scripts/ops/check-grafana-index.mjs || true
+      - name: Upload report
+        if: always()
+        uses: actions/upload-artifact@v4
+        with:
+          name: dashboards-index-report
+          path: reports/
+          retention-days: 7
\ No newline at end of file
diff --git a/scripts/ops/check-grafana-index.mjs b/scripts/ops/check-grafana-index.mjs
new file mode 100644
index 0000000..052f513
--- /dev/null
+++ b/scripts/ops/check-grafana-index.mjs
@@ -0,0 +1,52 @@
+#!/usr/bin/env node
+// scripts/ops/check-grafana-index.mjs
+// Recomputes dashboards index in memory and reports if it differs. Non-blocking.
+
+import fs from 'fs';
+import path from 'path';
+import crypto from 'crypto';
+
+const dir = path.resolve(process.cwd(), 'monitoring/grafana/dashboards');
+const indexPath = path.join(dir, 'index.json');
+
+function sha256(buf){ return crypto.createHash('sha256').update(buf).digest('hex'); }
+
+function loadDash(file){
+  try { const j = JSON.parse(fs.readFileSync(file,'utf8')); return j; } catch { return null; }
+}
+
+function buildIndex() {
+  const files = fs.existsSync(dir) ? fs.readdirSync(dir).filter(f=>f.endsWith('.json') && f !== 'index.json').sort() : [];
+  const dashboards = [];
+  for (const f of files) {
+    const full = path.join(dir, f);
+    const j = loadDash(full) || {};
+    const title = j.title || '';
+    const uid = j.uid || '';
+    const panelsCount = Array.isArray(j.panels) ? j.panels.length : 0;
+    const checksumSha256 = sha256(fs.readFileSync(full));
+    dashboards.push({ file: `monitoring/grafana/dashboards/${f}`, title, uid, panelsCount, checksumSha256 });
+  }
+  const generatedAt = new Date().toISOString();
+  return { generatedAt, dashboards };
+}
+
+function main(){
+  const rebuilt = buildIndex();
+  let disk = null;
+  try { disk = JSON.parse(fs.readFileSync(indexPath,'utf8')); } catch { }
+  const a = JSON.stringify(rebuilt, null, 2);
+  const b = disk ? JSON.stringify({ ...disk, generatedAt: rebuilt.generatedAt }, null, 2) : '';
+  if (a.trim() === b.trim()) {
+    console.log('Dashboards index deterministic: OK (no diff except timestamp).');
+    process.exit(0);
+  } else {
+    console.log('Dashboards index drift detected (report-only).');
+    fs.mkdirSync('reports', { recursive: true });
+    fs.writeFileSync('reports/dashboards_index.rebuilt.json', a);
+    if (b) fs.writeFileSync('reports/dashboards_index.disk.json', b);
+    process.exit(0);
+  }
+}
+
+main();
\ No newline at end of file
-- 
2.50.0.windows.1

